services:
  dashy:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: dashy
    restart: unless-stopped
    ports:
      - '3000:3000'
    environment:
      - NODE_ENV=production
      - PORT=3000
      - SESSION_SECRET=${SESSION_SECRET:?SESSION_SECRET is required}
      - SESSION_MAX_AGE_DAYS=${SESSION_MAX_AGE_DAYS:-7}
      - CORS_ORIGIN=${CORS_ORIGIN:-*}
      - RATE_LIMIT_AUTH_MAX=${RATE_LIMIT_AUTH_MAX:-5}
      - RATE_LIMIT_AUTH_STRICT_MAX=${RATE_LIMIT_AUTH_STRICT_MAX:-3}
      - RATE_LIMIT_API_MAX=${RATE_LIMIT_API_MAX:-100}
      - RATE_LIMIT_API_WRITE_MAX=${RATE_LIMIT_API_WRITE_MAX:-50}
      - RATE_LIMIT_PUBLIC_MAX=${RATE_LIMIT_PUBLIC_MAX:-60}
    volumes:
      - dashy-data:/app/data
      - dashy-backups:/app/data/backups
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:3000/api/health']
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    security_opt:
      - no-new-privileges:true
    read_only: false
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - SETGID
      - SETUID
      - NET_BIND_SERVICE

  # Development service with hot reload
  dashy-dev:
    build:
      context: .
      dockerfile: Dockerfile.dev
    container_name: dashy-dev
    profiles:
      - dev
    ports:
      - '3000:3000'
    environment:
      - NODE_ENV=development
      - PORT=3000
      - SESSION_SECRET=dev-secret-change-in-production-at-least-32-chars!!
      - CORS_ORIGIN=*
    volumes:
      - .:/app
      - dashy-dev-data:/app/data
    command: bun run dev

volumes:
  dashy-data:
    name: dashy-data
  dashy-backups:
    name: dashy-backups
  dashy-dev-data:
    name: dashy-dev-data
